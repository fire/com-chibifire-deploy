- hosts: all
  vars_files:
    - ./vars.yml
  vars:
  tasks:
    - name: upgrade all packages
      apk: upgrade=yes
    - name: install openjdk 1.8
      apk: name=openjdk8-jre state=latest
    - name: install bash
      apk: name=bash state=latest
    - name: install busybox-suid
      apk: name=busybox-suid state=latest 
    - name: install openssh server
      apk: name=openssh state=latest
    - name: install shadow package
      shell: apk add 'shadow' --update-cache --repository https://nl.alpinelinux.org/alpine/edge/community
    - name: remove root password
      shell: passwd -d root
    - name: add snappydata group 
      group: name=snappydata state=present
    - name: create snappydata directory
      file: path=/opt/snappydata state=directory
    - name: create snappydata user
      user: name=snappydata group=snappydata comment="SnappyData" home=/opt/snappydata shell=/bin/bash system=true generate_ssh_key=true
    - name: change snappydata directory ownership
      file: path=/opt/snappydata state=directory owner=snappydata group=snappydata
    - name: install tar package
      apk: name=tar state=latest
    - name: download snappydata
      get_url:
        url: https://github.com/SnappyDataInc/snappydata/releases/download/v0.6.1/snappydata-0.6.1-bin.tar.gz
        dest: /tmp/snappydata.tar.gz
        mode: 0440  
      become: yes
      become_user: snappydata  
    - name: extract snappydata
      shell: tar -xvf /tmp/snappydata.tar.gz --strip 1 -C /opt/snappydata
      become: yes
      become_user: snappydata
    - name: delete archive
      file: 
        path: /tmp/snappydata.tar.gz
        state: absent
    - name: Slurp public keys
      slurp: src="{{ item }}"
      with_items:
        - /opt/snappydata/.ssh/id_rsa.pub
      register: pki_certs
    - name: add key to authorized
      authorized_key: user=snappydata key="{{ item.content | b64decode }}"
      with_items: "{{ pki_certs.results }}"
  handlers:
